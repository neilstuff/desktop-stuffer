<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Dr Neil's Stuff</title>

    <link rel="stylesheet" href="assets/styles/main.css">

    <script type="text/template" id="template">
        <div id="card-<%=view%>-<%=id%>" class="card" style="border-bottom: 3px, solid white;" onclick="<%=callback%>('<%=id%>', '<%=view%>');">
            <img src="<%=image%>"></img>
            <label value="<%=label%>"><%=label%></label>
        </div>
    </script>

    <script type="text/template" id="view">
        <div class="details">
            <div class="center" style="font-size:14px">
                <h2>
                    <%=name%>
                </h2>
            </div>
            <div style="position:absolute; top:90px; left:0px; right:0x; bottom: 0px; overflow:auto; font-size:12px">
                <div style="margin:10px;">
                    <div>
                        <p>
                            <%=description%>
                        </p>
                    </div>
                    <div style="margin-top:<%=display%>;">
                        <img src="<%=display%>" style="display:block; <%=border%>; margin-left:auto; margin-right:auto; width:<%=width%>; height:<%=height%>;" </img>
                    </div>
                    <div>
                        <p>
                            <%=notes%>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="player">
        <div class="model" id="player-dialog" style="display:inline-block">
            <div style="position:absolute; padding:120px; top:-40px; bottom:0px; left:0px; right:0px; background: light-grey;">
                <div class="modal-content" style="margin-top:10px; width:<%=width%>px; height:<%=height%>px;">
                    <div class="modal-header " style="background-color: black ">
                        <span class="close" id="close" onclick="close_model_panel()">&times;</span>
                        <h2 id="viewer-dialog_title">
                            <%=title%>
                        </h2>
                    </div>
                    <div class="modal-body" style="background: rgba(0,0,0,0.0.5); margin-top:8px; margin-left:auto; margin-right:auto;">
                        <iframe id="player-viewer" src="<%=url%>" title="player" frameborder="0" width="<%=viewport-width%>" height="<%=viewport-height%>" style="transform:scale(<%=scale%>) translate(<%=translate-x%>px, <%=translate-y%>px);"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script>
        var manifests = [];
    </script>

    <script>
        function install_package() {
            var element = document.getElementById("package-url");

            window.api.install(element.value);

        }

        window.api.on('install-complete', (channel, args) => {

            close_model_panel();

        });

        function play(name, url, height, width, scale) {
            var element = document.getElementById("player");

            var template = element.text;
            var adjustment = parseFloat(scale);

            var adjustedWidth = parseInt(width);
            var adjustedHeight = parseInt(height);

            var viewportWidth = parseInt(width) - 30;
            var viewportHeight = parseInt(height) - 70;
            var translateX = 0;
            var translateY = 0;

            if (adjustment == 0.5) {
                translateX = -(viewportWidth * adjustment + 15);
                translateY = -(viewportHeight * adjustment + 5);

                console.log(translateX, translateY)

                adjustedWidth = adjustedWidth * adjustment;
                adjustedHeight = adjustedHeight * adjustment + 28;

            } else if (adjustment == 0.75) {
                translateX = -(viewportWidth * (1.00 - adjustment) - 54);
                translateY = -(viewportHeight * (1.00 - adjustment) - 50);

                console.log(translateX, translateY)

                adjustedWidth = adjustedWidth * adjustment - 18;
                adjustedHeight = adjustedHeight * adjustment;

            }

            var html = template.replace('<%=url%>', url).
                replace('<%=title%>', name).
                replace('<%=width%>', adjustedWidth).
                replace('<%=height%>', adjustedHeight).
                replace('<%=viewport-width%>', viewportWidth).
                replace('<%=viewport-height%>', viewportHeight).
                replace('<%=scale%>', parseFloat(scale)).
                replace('<%=translate-x%>', translateX).
                replace('<%=translate-y%>', translateY);


            document.getElementById('viewer').innerHTML = html;
            document.getElementById('player-viewer').focus();

        }

        function display(manifest, id, callback) {

            var element = document.getElementById("template");
            var template = element.text;

            var cardValue = template.replace(/<%=callback%>/g, callback).
                replace(/<%=id%>/g, id).
                replace(/<%=image%>/g, manifest.manifest + "/" + manifest.image).
                replace(/<%=label%>/g, manifest.label).
                replace(/<%=view%>/g, "cardbox");

            var card = document.getElementById("cardbox");

            card.innerHTML += cardValue;

        }

        function details(id, view) {
            var element = document.getElementById("view");
            var template = element.text;
            var entry = parseInt(id);
            var repository = manifests[entry];
            var description = "";

            for (var line in manifests[entry].description) {
                description += manifests[entry].description[line];
            }

            var html = template.replace(/<%=name%>/g, manifests[entry].label).
                replace(/<%=description%>/g, description);

            if ('display' in manifests[entry]) {
                html = html.replace(/<%=display%>/g, manifests[entry].manifest + "/" +
                    manifests[entry].display.image);
                html = html.replace(/<%=width%>/g, manifests[entry].display.width);
                html = html.replace(/<%=height%>/g, manifests[entry].display.height);
                html = html.replace(/<%=border%>/g, manifests[entry].display.border);
                html = html.replace(/<%=margin%>/g, manifests[entry].display.margin);
            }

            var notes = "";

            if ('notes' in manifests[entry]) {
                for (var note in manifests[entry].notes) {
                    notes += manifests[entry].notes[note];
                }

            }

            html = html.replace(/<%=notes%>/g, notes);

            var details = document.getElementById("details");

            details.innerHTML = html;

            var cards = document.getElementsByClassName('card');

            for (let card = 0; card < cards.length; card++) {
                cards[card].style.borderBottom = "3px solid white";
            }

            document.getElementById(`card-${view}-${id}`).style.borderBottom =
                "3px solid rgb(119,181,254)";

            document.getElementById("actions").style.display = "inline-block";

            var play = document.getElementById("play");
            var url = manifests[entry]['url'].replaceAll("\\", "\\\\");

            play.href = `javascript:play("${manifests[entry]['label']}", ` +
                `"${url}", ` +
                `"${manifests[entry]['play']['size']['height']}", ` +
                `"${manifests[entry]['play']['size']['width']}", ` +
                `"${manifests[entry]['play']['scale']}")`;
        }
    </script>
    <script>
        function help() {
            document.getElementById('help-dialog').style.display = "inline-block";
        }

        function close_model_panel() {
            var dialogs = document.getElementsByClassName('model')

            for (var dialog in dialogs) {
                if (dialogs[dialog].style) {
                    dialogs[dialog].style.display = "none";
                }

            }

            document.getElementById('viewer').innerHTML = "<html></html>";

        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", (event) => {

            document.addEventListener('dragover', event => event.preventDefault());
            document.addEventListener('drop', event => event.preventDefault());

            window.api.load();

        });

        window.api.on('load-complete', (channel, args) => {
            manifests = JSON.parse(args);

            for (var manifest in manifests) {
                display(manifests[manifest], manifest, "details");
            }

            document.getElementById('cards').style.display = "inline-block";

            var cards = document.getElementsByClassName('card');

            for (let card = 0; card < cards.length; card++) {
                cards[card].style.borderBottom = "3px solid white";
            }

        });

        window.setTimeout(function () {
            document.getElementById("splash-page").classList.toggle("hidden");

            window.setTimeout(function () {

                document.getElementById("main").style.display = "inline-block";

            }, 1500);

        }, 500);

    </script>
</head>

<body style=" overflow:hidden">
    <div id="splash-page" style="width:100%; height:100%;">
        <img id="logo" src="assets/images/logo.svg"
            style="width:300px; height:300px; display:block; margin-top:15%; margin-left:auto; margin-right:auto;"></img>
        <p style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; font-size: 14px;">
            (c) Neil Brittliff - 2024</p>
    </div>
    <div id="main" style="display:none">
        <div style="position:absolute; top:0px; height:40px; left:0px; right:0px; background-color:rgb(36,41,46)">
            <div style="position:absolute; top:2px; left:5px;">
                <img src="assets/images/adult-face.svg" width="32" height="32" />
            </div>
            <div style="position:absolute; top:-2px; height:40px; left:46px; right:0px; background-color:rgb(36,41,46)">
                <h1
                    style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #FFFFFF; font-size:16px; font-weight: 500; letter-spacing: 1px;">
                    The Stuff Navigator</h1>
                <div class="navbar" style="position:absolute; top:-10px; height:20px; right:-2px;">
                    <ul style="z-index: 100;">
                        <li class="dropdown">
                            <a class="drop_menu_item">
                                <svg style="width: 18px; height: 18px;" xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 448 512">
                                    <path
                                        d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"
                                        fill="white" />
                                </svg>
                            </a>
                            <div class="dropdown-content">
                                <a onclick="help()" title="Install">Install</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="stuff"
            style="position: absolute; top: 50px; bottom: 10px; left: 10px; right: 310px; border: 1px solid rgba(0, 0, 0, 0.2); background-color: rgb(255, 255, 255); ">
        </div>
        <div id="cards" class="view"
            style="position: absolute; top: 50px; bottom: 10px; left: 10px; right: 310px; border: 1px solid rgba(0, 0, 0, 0.2); flex-wrap: wrap; align-content: flex-start; background-color: rgb(255, 255, 255); overflow: auto; display:none;">
            <div id="cardbox" class="cardbox"> </div>
        </div>
        <div id="summary"
            style="position:absolute; top: 50px; bottom:10px; width:290px; right:10px; border:1px solid rgba(0,0,0,0.2);	background-color:rgb(255, 255, 255);">
            <div style="position:absolute; top: 0px; bottom:0px; left:0px; right:0px; padding:5px">
                <div id="details" style="position:absolute; top:0px; bottom:50px; left:0px; right:0px;">
                </div>
                <div id="actions"
                    style="display:none; position:absolute; height:32px; bottom:0px; left:0px; right:0px; margin:10px 10px 0px 10px; padding: 8px; border-top:1px solid rgba(0,0,0,0.2); ">
                    <span style="float:right"> <a id="play" href="null" class="actions"
                            style="cursor:pointer; width:32px; height:32px; font-size: 24px; text-decoration: none;">
                            <img src="assets/images/play.svg" width="32" height="32" style="cursor:pointer;" />
                        </a>
                    </span>
                </div>
            </div>
        </div>
        <div class="model" id="help-dialog" style="display:none">
            <div style="position:absolute; padding:120px; top:0px; bottom:0px; left:0px; right:0px;">
                <div class="modal-content" style="margin-top:40px; width:540px;">
                    <div class="modal-header" style="background-color: black">
                        <span class="close" id="close" onclick="close_model_panel()">&times;</span>
                        <h2 id="dialog_title">Add a package</h2>
                    </div>
                    <div class="modal-body" id="text" style="background: rgba(0,0,0,0.0.5); height:150px;">
                        <div id="getting_started_panel" class="modal-scroll-panel"
                            style="position:absolute; top:50px; bottom:36px; left:0px; right:0px; overflow:auto; ">
                            <table style="margin:5px;" cellpadding="10">
                                <tr>
                                    <td><label class="modal-label"></label>Package URL</td>
                                    <td><input class="modal-entry" id="package-url" type="text" name="package-url"
                                            placeholder="URL..." required></input>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div style="padding: 10px; margin-left:10px;">
                        <button class="modal-btn" id="install-package" onclick="install_package();">Install</button>
                        <button class="modal-cancel-btn" id="cancel-install"
                            onclick="close_model_panel();">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewer">
        </div>

    </div>

</body>

</html>